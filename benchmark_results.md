# Anemoi Merkle Tree Performance Benchmark Results

## 测试环境
- 系统: macOS Darwin 24.5.0  
- 处理器: Apple Silicon
- 编译模式: Release (优化)
- 日期: 2025-07-28

## 电路版本状态

### 当前实现状态
- **circuit_complete.rs**: ✅ **完整学术级实现** (当前使用版本)
  - 12个advice列，8个专门的选择器
  - 完整的14轮Anemoi变换约束
  - 完全符合学术标准的密码学实现
  - 支持三元Merkle树 (3个子节点)

- **circuit_optimized.rs**: ⚠️ **部分优化实现** (包含约束问题)
  - 5个advice列 (TurboPlonk标准)
  - 基于reference实现的约束模式
  - 存在Halo2选择器使用限制问题
  - 需要进一步修复约束系统

- **circuit_simple.rs**: ✅ **简化演示实现**
  - 5个advice列，3个约束门
  - 使用二次约束替代5次幂约束
  - 仅用于学习和演示，非密码学等价

## 性能基准测试结果

### Complete Circuit (circuit_complete.rs)
使用完整的学术级Anemoi实现进行不同深度Merkle树的性能测试：

| 深度 | 证明时间(ms) | 验证时间(ms) | k值 | 备注 |
|------|-------------|-------------|-----|------|
| 4    | 304         | 3           | 12  | 小规模测试 |
| 8    | 327         | 3           | 12  | 常见应用深度 |
| 16   | 582         | 3           | 13  | 中等规模树 |
| 32   | 1,079       | 3           | 14  | 大规模应用 |
| 64   | 1,952       | 3           | 15  | 企业级应用 |
| 128  | 3,773       | 3           | 16  | 大型系统 |
| 256  | 7,632       | 3           | 17  | 极大规模 |

### 性能分析

1. **证明时间增长**:
   - 深度4→8: 增长7.6% (304→327ms)
   - 深度8→16: 增长78% (327→582ms)  
   - 深度16→32: 增长85% (582→1,079ms)
   - 深度32→64: 增长81% (1,079→1,952ms)
   - 深度64→128: 增长93% (1,952→3,773ms)
   - 深度128→256: 增长102% (3,773→7,632ms)

2. **验证时间**:
   - 所有深度下验证时间稳定在3ms
   - 验证复杂度与Merkle树深度无关
   - 优秀的验证者效率

3. **电路规模**:
   - 每个Merkle层需要约56个约束行 (14轮 × 4步骤)
   - 内存使用随证明深度线性增长
   - 推荐k=14用于合理的证明大小

## 优化分析

### Reference实现对比
经分析`reference/`目录中的实现，发现以下优化机会：

1. **列数减少**: 从12列减少到5列 (TurboPlonk标准)
2. **门合并**: 将多个Anemoi操作合并到更少的约束门
3. **选择器优化**: 使用预处理轮密钥替代witness存储
4. **约束效率**: 直接5次幂约束替代分解操作
5. **旋转优化**: 更好利用Rotation::next()连接轮次

### 实现挑战
1. **Halo2选择器限制**: 不能在加法表达式中使用选择器
2. **表达式所有权**: 需要仔细克隆Expression对象
3. **密码学正确性**: 维护精确的Anemoi规范
4. **度约束**: 5次幂表达式增加约束度

### 优化建议
1. **生产环境**: 使用`circuit_complete.rs`确保密码学正确性
2. **研究用途**: 检查reference实现的约束模式
3. **学习目的**: 研究`circuit_simple.rs`的基本Halo2模式
4. **性能优化**: 专注于选择器使用模式和表达式管理

## 测试命令

```bash
# 运行完整基准测试
cargo run --example benchmark_depths --release

# 测试单一深度 (完整电路)
cargo run --example simple_timing_test --release

# 检查约束系统
cargo check
cargo clippy
```

## 约束系统对比

### Complete vs Reference约束
- **Complete**: 完整的14轮约束，每轮4个子约束
- **Reference**: TurboPlonk风格约束，使用预处理选择器
- **主要差异**: 列数 (12 vs 5) 和约束组织方式

### 验证Hash一致性
两种实现的hash函数计算结果一致，验证了密码学等价性：
- Anemoi-2-1变种 (2分支，1输出)
- Jive压缩: sum_before + sum_after 置换
- 14轮安全参数
- 支持4元输入 (left, middle, right, padding)

---

*基准测试于2025-07-28完成，使用Apple Silicon处理器和cargo release优化*
